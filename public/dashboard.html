<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clocwise Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7fafc;
            color: #1a365d;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(26, 54, 93, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #edf2f7;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .clock-icon {
            width: 25px;
            height: 25px;
            border: 2px solid #38a169;
            border-radius: 50%;
            position: relative;
        }

        .clock-icon::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 50%;
            width: 1.5px;
            height: 6px;
            background: #38a169;
            transform: translateX(-50%);
        }

        .clock-icon::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            width: 1px;
            height: 4px;
            background: #38a169;
            transform: translateX(-50%) rotate(90deg);
            transform-origin: bottom;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .user-info:hover {
            background: #f7fafc;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #38a169, #2f855a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(229, 62, 62, 0.2);
        }

        .logout-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(229, 62, 62, 0.3);
        }

        /* Main Layout */
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a365d;
        }

        /* Timer Section */
        .timer-card {
            text-align: center;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
        }

        .timer-btn {
            padding: 12px 25px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .timer-btn:hover {
            background: white;
            color: #1a365d;
        }

        .timer-btn.primary {
            background: #38a169;
            border-color: #38a169;
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.25);
        }

        .timer-btn.primary:hover {
            background: #2f855a;
            border-color: #2f855a;
            color: white;
            box-shadow: 0 6px 16px rgba(56, 161, 105, 0.35);
        }

        .project-selector {
            margin-top: 20px;
        }

        .project-selector select {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
        }

        .project-selector select option {
            background: #1a365d;
            color: white;
        }

        /* Quick Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #edf2f7;
            box-shadow: 0 2px 4px rgba(26, 54, 93, 0.04);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #38a169;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: 5px;
        }

        /* Recent Activity */
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #edf2f7;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            flex: 1;
        }

        .activity-project {
            font-weight: 600;
            color: #1a365d;
        }

        .activity-time {
            font-size: 0.9rem;
            color: #4a5568;
        }

        .activity-duration {
            font-weight: 600;
            color: #38a169;
        }

        .activity-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #4299e1;
            color: white;
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
        }

        .btn-small:hover {
            opacity: 0.8;
        }

        /* Clients Section */
        .client-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #edf2f7;
        }

        .client-item:last-child {
            border-bottom: none;
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-weight: 600;
            color: #1a365d;
        }

        .client-rate {
            font-size: 0.9rem;
            color: #38a169;
        }

        .add-btn {
            background: #38a169;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(56, 161, 105, 0.2);
        }

        .add-btn:hover {
            background: #2f855a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(56, 161, 105, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1a365d;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            color: #1a365d;
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1a365d;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #edf2f7;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #38a169;
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.1);
        }

        .btn-primary {
            background: #38a169;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(56, 161, 105, 0.2);
        }

        .btn-primary:hover {
            background: #2f855a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(56, 161, 105, 0.3);
        }

        /* Current Activity Banner */
        .current-activity {
            background: linear-gradient(135deg, #38a169, #48bb78);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.2);
        }

        .current-activity.show {
            display: block;
        }

        .current-activity-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .timer-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="clock-icon"></div>
                Clocwise
            </div>
            <div class="user-menu">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span id="userName"></span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Current Activity Banner -->
    <div class="current-activity" id="currentActivityBanner">
        <div class="current-activity-info">
            <div>
                <span class="pulse">ðŸ”´</span> Currently tracking: <strong id="currentProject">Project Name</strong>
            </div>
            <div>
                <strong id="currentDuration">00:00:00</strong>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Timer Card -->
            <div class="card timer-card">
                <h2 class="card-title" style="color: white;">Time Tracker</h2>
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn primary" id="startBtn" onclick="startTimer()">Start</button>
                    <button class="timer-btn" id="pauseBtn" onclick="pauseTimer()" style="display: none;">Pause</button>
                    <button class="timer-btn" id="stopBtn" onclick="stopTimer()" style="display: none;">Stop</button>
                </div>
                <div class="project-selector">
                    <select id="projectSelect">
                        <option value="">Select a project...</option>
                    </select>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Today's Summary</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="todayHours">0.0</div>
                        <div class="stat-label">Hours Today</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="weekHours">0.0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="monthHours">0.0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalEarnings">$0</div>
                        <div class="stat-label">Earnings</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Activity</h3>
                    <button class="add-btn" onclick="showAddTimeModal()">+ Add Time</button>
                </div>
                <div class="activity-list" id="activityList">
                    <!-- Activity items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Clients -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Clients</h3>
                    <button class="add-btn" onclick="showAddClientModal()">+ Add Client</button>
                </div>
                <div class="client-list" id="clientList">
                    <!-- Client items will be populated here -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h3 class="card-title">Quick Actions</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button class="btn-primary" onclick="generateInvoice()">Generate Invoice</button>
                    <button class="btn-primary" onclick="exportData()">Export Data</button>
                    <button class="btn-primary" onclick="viewReports()">View Reports</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Client</h3>
                <button class="close-btn" onclick="hideModal('clientModal')">&times;</button>
            </div>
            <form id="clientForm">
                <div class="form-group">
                    <label for="clientName">Client Name</label>
                    <input type="text" id="clientName" name="clientName" required>
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" name="clientEmail">
                </div>
                <div class="form-group">
                    <label for="hourlyRate">Hourly Rate ($)</label>
                    <input type="number" id="hourlyRate" name="hourlyRate" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" name="projectName" required>
                </div>
                <div class="form-group">
                    <label for="projectDescription">Project Description</label>
                    <textarea id="projectDescription" name="projectDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary">Add Client</button>
            </form>
        </div>
    </div>

    <!-- Add Time Modal -->
    <div class="modal" id="timeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Time Entry</h3>
                <button class="close-btn" onclick="hideModal('timeModal')">&times;</button>
            </div>
            <form id="timeForm">
                <div class="form-group">
                    <label for="timeProject">Project</label>
                    <select id="timeProject" name="timeProject" required>
                        <option value="">Select a project...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeDate">Date</label>
                    <input type="date" id="timeDate" name="timeDate" required>
                </div>
                <div class="form-group">
                    <label for="timeStart">Start Time</label>
                    <input type="time" id="timeStart" name="timeStart" required>
                </div>
                <div class="form-group">
                    <label for="timeEnd">End Time</label>
                    <input type="time" id="timeEnd" name="timeEnd" required>
                </div>
                <div class="form-group">
                    <label for="timeDescription">Description</label>
                    <textarea id="timeDescription" name="timeDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary">Add Time Entry</button>
            </form>
        </div>
    </div>

    <script>
        // API Configuration - works for both local and production
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3001' : window.location.origin;
        
        // Supabase Configuration - Consider moving to environment variables
        // API Helper Function for JWT Authentication
        async function apiRequest(endpoint, options = {}) {
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                window.location.href = 'auth.html';
                return;
            }
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, finalOptions);
                
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = 'auth.html';
                    return;
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'API request failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request error:', error);
                throw error;
            }
        }

        // Global variables
        let currentUser = null;
        let clients = [];
        let timeEntries = [];
        let timerState = {
            isRunning: false,
            startTime: null,
            currentProject: null,
            elapsedTime: 0
        };
        let timerInterval = null;

        // Initialize dashboard
        async function initDashboard() {
            try {
                // Check if user is authenticated
                const authToken = localStorage.getItem('authToken');
                const userData = localStorage.getItem('user');
                
                if (!authToken || !userData) {
                    window.location.href = 'auth.html';
                    return;
                }

                // Set current user from localStorage
                currentUser = JSON.parse(userData);

                // Set user info
                document.getElementById('userName').textContent = currentUser.fullName;
                document.getElementById('userAvatar').textContent = currentUser.fullName.charAt(0).toUpperCase();

                // Set today's date for time form
                document.getElementById('timeDate').value = new Date().toISOString().split('T')[0];

                // Load data
                await loadClients();
                await loadTimeEntries();
                await loadStats();
                populateProjectSelects();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                window.location.href = 'auth.html';
            }
        }

        // Express API Data Functions
        async function loadClients() {
            try {
                const clientsData = await apiRequest('/api/clients');
                clients = clientsData || [];
                const clientList = document.getElementById('clientList');

                if (clients.length === 0) {
                    clientList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No clients yet. Add your first client!</p>';
                    return;
                }

                clientList.innerHTML = clients.map(client => `
                    <div class="client-item">
                        <div class="client-info">
                            <div class="client-name">${client.name}</div>
                            <div class="client-rate">$${client.hourly_rate}/hour</div>
                        </div>
                        <div class="activity-actions">
                            <button class="btn-small btn-edit" onclick="editClient(${client.id})">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteClient(${client.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading clients:', error);
                const clientList = document.getElementById('clientList');
                clientList.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading clients. Please refresh the page.</p>';
            }
        }

        async function loadTimeEntries() {
            try {
                const timeEntriesData = await apiRequest('/api/time-entries?limit=10');
                timeEntries = timeEntriesData || [];
                const activityList = document.getElementById('activityList');

                if (timeEntries.length === 0) {
                    activityList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No time entries yet. Start tracking!</p>';
                    return;
                }

                activityList.innerHTML = timeEntries.map(entry => {
                    const duration = formatDuration(entry.duration);
                    const date = new Date(entry.date).toLocaleDateString();
                    const projectName = entry.client_name && entry.project_name ? 
                        `${entry.client_name} - ${entry.project_name}` : 'Unknown Project';

                    return `
                        <div class="activity-item">
                            <div class="activity-info">
                                <div class="activity-project">${projectName}</div>
                                <div class="activity-time">${date} at ${entry.start_time}</div>
                            </div>
                            <div class="activity-duration">${duration}</div>
                            <div class="activity-actions">
                                <button class="btn-small btn-edit" onclick="editTimeEntry(${entry.id})">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteTimeEntry(${entry.id})">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading time entries:', error);
                const activityList = document.getElementById('activityList');
                activityList.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading time entries. Please refresh the page.</p>';
            }
        }

        async function loadStats() {
            try {
                const stats = await apiRequest('/api/stats');
                
                const todayHours = parseFloat(stats.todayHours) || 0;
                const weekHours = parseFloat(stats.weekHours) || 0; 
                const monthHours = parseFloat(stats.monthHours) || 0;
                const totalEarnings = parseFloat(stats.totalEarnings) || 0;

                document.getElementById('todayHours').textContent = todayHours.toFixed(1);
                document.getElementById('weekHours').textContent = weekHours.toFixed(1);
                document.getElementById('monthHours').textContent = monthHours.toFixed(1);
                document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(0)}`;
            } catch (error) {
                console.error('Error loading stats:', error);
                // Set default values on error
                document.getElementById('todayHours').textContent = '0.0';
                document.getElementById('weekHours').textContent = '0.0';
                document.getElementById('monthHours').textContent = '0.0';
                document.getElementById('totalEarnings').textContent = '$0';
            }
        }

        // Timer functions
        function startTimer() {
            const projectSelect = document.getElementById('projectSelect');
            if (!projectSelect.value) {
                alert('Please select a project first');
                return;
            }

            timerState.isRunning = true;
            timerState.startTime = Date.now() - timerState.elapsedTime;
            timerState.currentProject = projectSelect.value;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';

            // Show current activity banner
            document.getElementById('currentActivityBanner').classList.add('show');
            document.getElementById('currentProject').textContent = getProjectName(timerState.currentProject);

            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function pauseTimer() {
            timerState.isRunning = false;
            clearInterval(timerInterval);

            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').textContent = 'Resume';
        }

        async function stopTimer() {
            if (timerState.elapsedTime > 0) {
                // Save time entry via Supabase
                const duration = Math.floor(timerState.elapsedTime / 1000);
                
                // Debug logging
                console.log('Stopping timer - currentUser:', currentUser);
                console.log('Timer state:', timerState);
                
                const timeEntryData = {
                    user_id: currentUser.id,
                    project_id: timerState.currentProject,
                    date: new Date().toISOString().split('T')[0],
                    start_time: new Date(timerState.startTime).toTimeString().slice(0, 5),
                    duration: duration,
                    description: 'Tracked with timer'
                };
                
                console.log('Time entry data:', timeEntryData);

                try {
                    const result = await apiRequest('/api/time-entries', {
                        method: 'POST',
                        body: JSON.stringify({
                            projectId: timerState.currentProject,
                            date: new Date().toISOString().split('T')[0],
                            startTime: new Date(timerState.startTime).toTimeString().slice(0, 5),
                            duration: duration,
                            description: 'Tracked with timer'
                        })
                    });
                    
                    console.log('Time entry saved successfully');
                } catch (error) {
                    console.error('Error saving timer entry:', error);
                    alert('Failed to save time entry: ' + error.message);
                }
            }

            // Reset timer
            timerState = {
                isRunning: false,
                startTime: null,
                currentProject: null,
                elapsedTime: 0
            };

            clearInterval(timerInterval);
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').textContent = 'Start';
            document.getElementById('currentActivityBanner').classList.remove('show');

            await loadTimeEntries();
            await loadStats();
        }

        function updateTimerDisplay() {
            if (timerState.isRunning) {
                timerState.elapsedTime = Date.now() - timerState.startTime;
            }

            const totalSeconds = Math.floor(timerState.elapsedTime / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            
            if (document.getElementById('currentActivityBanner').classList.contains('show')) {
                document.getElementById('currentDuration').textContent = display;
            }
        }

        // Client management (using Supabase)

        function showAddClientModal() {
            document.getElementById('clientModal').classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Time entries (using Supabase)

        function showAddTimeModal() {
            document.getElementById('timeModal').classList.add('show');
        }

        // Utility functions
        function getProjectName(projectId) {
            const client = clients.find(c => c.projects && c.projects.find(p => p.id === projectId));
            if (client) {
                const project = client.projects.find(p => p.id === projectId);
                return `${client.name} - ${project.name}`;
            }
            return 'Unknown Project';
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function populateProjectSelects() {
            const selects = ['projectSelect', 'timeProject'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select a project...</option>';
                
                // clients is already filtered for current user from API
                clients.forEach(client => {
                    if (client.projects && client.projects.length > 0) {
                        client.projects.forEach(project => {
                            select.innerHTML += `<option value="${project.id}">${client.name} - ${project.name}</option>`;
                        });
                    }
                });
            });
        }

        // Stats loading is already implemented in the loadStats function above

        // Utility function for formatting duration (in seconds) to human-readable string

        // Event handlers (using Supabase)

        // Time form handler is implemented in handleTimeForm function below

        // Quick action functions
        async function generateInvoice() {
            if (clients.length === 0) {
                alert('Please add clients first to generate invoices');
                return;
            }

            // Get date range for invoice (default to current month)
            const startDate = prompt('Enter start date (YYYY-MM-DD):', getFirstDayOfMonth());
            if (!startDate) return;
            
            const endDate = prompt('Enter end date (YYYY-MM-DD):', getTodayDate());
            if (!endDate) return;

            try {
                // Get time entries for the period
                const { data: timeEntries, error } = await supabaseClient
                    .from('time_entries')
                    .select(`
                        *,
                        projects (
                            name,
                            clients (
                                name,
                                email,
                                hourly_rate
                            )
                        )
                    `)
                    .eq('user_id', currentUser.id)
                    .gte('date', startDate)
                    .lte('date', endDate)
                    .order('date', { ascending: true });

                if (error) throw error;

                if (!timeEntries || timeEntries.length === 0) {
                    alert('No time entries found for the selected period.');
                    return;
                }

                // Group entries by client
                const clientGroups = {};
                timeEntries.forEach(entry => {
                    const client = entry.projects.clients;
                    const clientKey = client.name;
                    
                    if (!clientGroups[clientKey]) {
                        clientGroups[clientKey] = {
                            client: client,
                            entries: [],
                            totalHours: 0,
                            totalAmount: 0
                        };
                    }
                    
                    const hours = entry.duration / 3600;
                    const amount = hours * client.hourly_rate;
                    
                    clientGroups[clientKey].entries.push({
                        ...entry,
                        hours: hours,
                        amount: amount
                    });
                    
                    clientGroups[clientKey].totalHours += hours;
                    clientGroups[clientKey].totalAmount += amount;
                });

                // Generate HTML invoice
                generateInvoiceHTML(clientGroups, startDate, endDate);

            } catch (error) {
                console.error('Error generating invoice:', error);
                alert('Failed to generate invoice: ' + error.message);
            }
        }

        function getFirstDayOfMonth() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function generateInvoiceHTML(clientGroups, startDate, endDate) {
            const invoiceNumber = 'INV-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6);
            const invoiceDate = new Date().toLocaleDateString();
            
            // Calculate grand total
            let grandTotal = 0;
            Object.values(clientGroups).forEach(group => {
                grandTotal += group.totalAmount;
            });

            const invoiceHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Invoice ${invoiceNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                    .invoice-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                    .company-info { float: left; width: 50%; }
                    .invoice-info { float: right; width: 45%; text-align: right; }
                    .clearfix::after { content: ""; display: table; clear: both; }
                    .client-section { margin: 20px 0; }
                    .client-header { background-color: #f0f0f0; padding: 10px; margin: 20px 0 10px 0; font-weight: bold; }
                    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f9f9f9; font-weight: bold; }
                    .text-right { text-align: right; }
                    .total-section { margin-top: 30px; }
                    .grand-total { font-size: 1.2em; font-weight: bold; background-color: #e8f5e8; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="invoice-header">
                    <h1>INVOICE</h1>
                    <p>Professional Time Tracking Services</p>
                </div>

                <div class="clearfix">
                    <div class="company-info">
                        <h3>${currentUser.fullName}</h3>
                        <p>Email: ${currentUser.email}</p>
                        <p>Generated via Clocwise</p>
                    </div>
                    <div class="invoice-info">
                        <p><strong>Invoice #:</strong> ${invoiceNumber}</p>
                        <p><strong>Invoice Date:</strong> ${invoiceDate}</p>
                        <p><strong>Period:</strong> ${startDate} to ${endDate}</p>
                    </div>
                </div>

                ${Object.entries(clientGroups).map(([clientName, group]) => `
                <div class="client-section">
                    <div class="client-header">
                        Bill To: ${group.client.name}
                        ${group.client.email ? `<br>Email: ${group.client.email}` : ''}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Project</th>
                                <th>Description</th>
                                <th>Hours</th>
                                <th>Rate</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${group.entries.map(entry => `
                            <tr>
                                <td>${new Date(entry.date).toLocaleDateString()}</td>
                                <td>${entry.projects.name}</td>
                                <td>${entry.description || 'Time tracking'}</td>
                                <td>${entry.hours.toFixed(2)}</td>
                                <td>$${group.client.hourly_rate.toFixed(2)}</td>
                                <td class="text-right">$${entry.amount.toFixed(2)}</td>
                            </tr>
                            `).join('')}
                            <tr class="total-section">
                                <td colspan="5"><strong>Subtotal for ${group.client.name}:</strong></td>
                                <td class="text-right"><strong>$${group.totalAmount.toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `).join('')}

                <div class="total-section">
                    <table>
                        <tr class="grand-total">
                            <td><strong>GRAND TOTAL:</strong></td>
                            <td class="text-right"><strong>$${grandTotal.toFixed(2)}</strong></td>
                        </tr>
                    </table>
                </div>

                <div class="no-print" style="margin-top: 30px; text-align: center;">
                    <button onclick="window.print()" style="padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Invoice</button>
                    <button onclick="window.close()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                </div>
            </body>
            </html>
            `;

            // Create downloadable HTML file
            const blob = new Blob([invoiceHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `invoice-${invoiceNumber}.html`;
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Clean up
            URL.revokeObjectURL(url);
            
            // Also try to open in new window (will work if popups are allowed)
            try {
                const invoiceWindow = window.open('', '_blank');
                if (invoiceWindow) {
                    invoiceWindow.document.write(invoiceHTML);
                    invoiceWindow.document.close();
                } else {
                    alert('Invoice downloaded! Check your Downloads folder for the HTML file. You can open it in your browser to view and print.');
                }
            } catch (error) {
                alert('Invoice downloaded! Check your Downloads folder for the HTML file. You can open it in your browser to view and print.');
            }
        }

        function exportData() {
            const userData = {
                clients: clients,
                timeEntries: timeEntries
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clocwise-data-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function viewReports() {
            alert('Advanced reporting dashboard coming soon! This would show detailed analytics, charts, and insights.');
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Space to start/stop timer
            if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                e.preventDefault();
                if (timerState.isRunning) {
                    pauseTimer();
                } else if (timerState.elapsedTime > 0) {
                    startTimer();
                } else {
                    const projectSelect = document.getElementById('projectSelect');
                    if (projectSelect.value) {
                        startTimer();
                    } else {
                        alert('Please select a project first');
                    }
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Auto-save timer state
        setInterval(() => {
            if (timerState.isRunning) {
                localStorage.setItem('clocwiseTimerState', JSON.stringify({
                    ...timerState,
                    savedAt: Date.now()
                }));
            }
        }, 5000);

        // Restore timer state on page load
        function restoreTimerState() {
            const savedState = localStorage.getItem('clocwiseTimerState');
            if (savedState) {
                const state = JSON.parse(savedState);
                const timeSinceLastSave = Date.now() - state.savedAt;
                
                // Only restore if less than 1 hour has passed
                if (timeSinceLastSave < 3600000 && state.isRunning) {
                    timerState = {
                        ...state,
                        elapsedTime: state.elapsedTime + timeSinceLastSave
                    };
                    
                    document.getElementById('projectSelect').value = state.currentProject;
                    startTimer();
                    
                    // Clear the saved state
                    localStorage.removeItem('clocwiseTimerState');
                }
            }
        }

        // Form Handlers
        async function handleClientForm(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Debug: log form data
            console.log('Form data:', {
                clientName: formData.get('clientName'),
                clientEmail: formData.get('clientEmail'),
                hourlyRate: formData.get('hourlyRate'),
                projectName: formData.get('projectName'),
                projectDescription: formData.get('projectDescription')
            });
            
            // Validate required fields
            const clientName = formData.get('clientName');
            const hourlyRate = formData.get('hourlyRate');
            const projectName = formData.get('projectName');
            
            if (!clientName || !clientName.trim()) {
                alert('Client Name is required');
                return;
            }
            
            if (!hourlyRate || isNaN(parseFloat(hourlyRate))) {
                alert('Valid Hourly Rate is required');
                return;
            }
            
            if (!projectName || !projectName.trim()) {
                alert('Project Name is required');
                return;
            }

            const clientData = {
                user_id: currentUser.id,
                name: clientName.trim(),
                email: formData.get('clientEmail') || '',
                hourly_rate: parseFloat(hourlyRate)
            };

            const projectData = {
                name: projectName.trim(),
                description: formData.get('projectDescription') || '',
                status: 'active'
            };

            try {
                // Create client with project
                const result = await apiRequest('/api/clients', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: clientName.trim(),
                        email: formData.get('clientEmail') || '',
                        hourlyRate: parseFloat(hourlyRate),
                        projectName: projectName.trim(),
                        projectDescription: formData.get('projectDescription') || ''
                    })
                });
                
                hideModal('clientModal');
                await loadClients();
                populateProjectSelects();
                e.target.reset();
            } catch (error) {
                console.error('Error creating client:', error);
                alert('Failed to create client: ' + error.message);
            }
        }

        async function handleTimeForm(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const startTime = formData.get('timeStart');
            const endTime = formData.get('timeEnd');
            
            // Calculate duration
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const durationMs = end - start;
            
            if (durationMs <= 0) {
                alert('End time must be after start time');
                return;
            }

            const timeEntryData = {
                user_id: currentUser.id,
                project_id: formData.get('timeProject'),
                date: formData.get('timeDate'),
                start_time: startTime,
                duration: Math.floor(durationMs / 1000),
                description: formData.get('timeDescription') || ''
            };

            try {
                await apiRequest('/api/time-entries', {
                    method: 'POST',
                    body: JSON.stringify({
                        projectId: formData.get('timeProject'),
                        date: formData.get('timeDate'),
                        startTime: startTime,
                        duration: Math.floor(durationMs / 1000),
                        description: formData.get('timeDescription') || ''
                    })
                });
                
                hideModal('timeModal');
                await loadTimeEntries();
                await loadStats();
                e.target.reset();
            } catch (error) {
                console.error('Error creating time entry:', error);
                alert('Failed to create time entry: ' + error.message);
            }
        }

        async function deleteTimeEntry(entryId) {
            if (confirm('Are you sure you want to delete this time entry?')) {
                try {
                    await apiRequest(`/api/time-entries/${entryId}`, {
                        method: 'DELETE'
                    });
                    
                    await loadTimeEntries();
                    await loadStats();
                } catch (error) {
                    console.error('Error deleting time entry:', error);
                    alert('Failed to delete time entry: ' + error.message);
                }
            }
        }

        async function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client and all associated projects and time entries?')) {
                try {
                    await apiRequest(`/api/clients/${clientId}`, {
                        method: 'DELETE'
                    });
                    
                    await loadClients();
                    populateProjectSelects();
                    await loadTimeEntries();
                    await loadStats();
                } catch (error) {
                    console.error('Error deleting client:', error);
                    alert('Failed to delete client: ' + error.message);
                }
            }
        }

        function editClient(clientId) {
            alert('Edit client feature coming soon!');
        }

        function editTimeEntry(entryId) {
            alert('Edit time entry feature coming soon!');
        }

        function showAddClientModal() {
            document.getElementById('clientModal').classList.add('show');
        }

        function showAddTimeModal() {
            document.getElementById('timeModal').classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                
                // Redirect to auth page
                window.location.href = 'auth.html';
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add form event listeners
            document.getElementById('clientForm').addEventListener('submit', handleClientForm);
            document.getElementById('timeForm').addEventListener('submit', handleTimeForm);
            
            initDashboard();
        });

        // Update timer display every second
        setInterval(updateTimerDisplay, 1000);
    </script>
</body>
</html>